<!DOCTYPE html>
<html lang="ja">
<head>
  <title>Chart.js TEST</title>
  <meta charset="UTF-8">
</head>
<body>
  <h1>鳥の温度 (現在の温度 : <span id="current"></span>℃)</h1>

  <div style="width: 50%">
    <!-- <canvas id="chart" height="1000" width="1500"></canvas> -->
    <canvas id="chart_ema" height="700" width="1500"></canvas>
  </div>

    <script src="Chart.min.js"></script>
  <script>
  var API_END_POINT = "https://script.google.com/macros/s/AKfycbw3L1MfE0SPj0Nd-oQH3ePD8pxqPUEomJ94jvJ-5UcT6AFEDt39/exec"
  function EMACalc(mArray,mRange) {
    var k = 2/(mRange + 1);
    // first item is just the same as the first item in the input
    emaArray = [mArray[0]];
    // for the rest of the items, they are computed with the previous one
    for (var i = 1; i < mArray.length; i++) {
      emaArray.push(mArray[i] * k + emaArray[i - 1] * (1 - k));
    }
    return emaArray;
  }
  function drawBarChart(data) {
    console.dir(data);
    // 3)chart.jsのdataset用の配列を用意
    var tmpLabels = [], tmpData1 = [];

    tmpLabels=data.map(function(element, index, array) {
      return element["date"];
    });
    tmpData1=data.map(function(element, index, array) {
      return element["data"];
    });


    data1 = EMACalc(tmpData1, 4);
    // 4)chart.jsで描画
    // var ctx = document.getElementById("chart").getContext("2d");
    // var myChart = new Chart(ctx, {
    //   type: 'line',
    //   data: {
    //     labels: tmpLabels,
    //     datasets: [
    //       {
    //         label: "thermo",
    //         //折れ線グラフとX軸の間に色を描画するか否か
    //        fill: false,
    //        //背景色
    //        backgroundColor: "rgba(75,192,192,0.4)",
    //        //境界線の色
    //        borderColor: "rgba(75,192,192,1)",
    //        //点の色
    //        pointBorderColor: "rgba(75,192,192,1)",
    //        //点のサイズ
    //        pointBorderWidth: 0.5,
    //        pointHoverRadius: 5,
    //        pointRadius: 0.5,
    //        //点にマウスオーバーした時の設定
    //        pointHoverBackgroundColor: "rgba(75,192,192,1)",
    //        pointHoverBorderColor: "rgba(220,220,220,1)",
    //        pointHoverBorderWidth: 1,
    //       data: tmpData1,
    //       backgroundColor: "red" }
    //     ]
    //   },
    //   options: { responsive: true }
    // });
    var ctx1 = document.getElementById("chart_ema").getContext("2d");
    var myChart1 = new Chart(ctx1, {
      type: 'line',
      data: {
        labels: tmpLabels,
        datasets: [
          {
            label: "thermo",
            //折れ線グラフとX軸の間に色を描画するか否か
           fill: false,
           //背景色
           backgroundColor: "rgba(75,192,192,0.4)",
           //境界線の色
           borderColor: "rgba(75,192,192,1)",
           //点の色
           pointBorderColor: "rgba(75,192,192,1)",
           //点のサイズ
           pointBorderWidth: 0.5,
           pointHoverRadius: 5,
           pointRadius: 0.5,
           //点にマウスオーバーした時の設定
           pointHoverBackgroundColor: "rgba(75,192,192,1)",
           pointHoverBorderColor: "rgba(220,220,220,1)",
           pointHoverBorderWidth: 1,
          data: data1,
          backgroundColor: "red" }
        ]
      },
      options: { responsive: false }
    });
    document.getElementById("current").innerHTML=Math.round(data1[data1.length-1]*10)/10;
  }
z
  function main() {
    // 1) ajaxでCSVファイルをロード
    var req = new XMLHttpRequest();
    var filePath = 'data.csv';
    req.open("GET", API_END_POINT, true);
    req.onload = function() {
      // 2) CSVデータ変換の呼び出し
      data = JSON.parse(req.responseText);
      // 3) chart.jsデータ準備、4) chart.js描画の呼び出し
      drawBarChart(data);
    }
    req.send(null);
  }

  main();

  </script>
</body>
</html>
